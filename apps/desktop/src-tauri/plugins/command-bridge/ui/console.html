<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>Command Bridge Console</title>
    <style>
      :root {
        color-scheme: dark;
      }
      body {
        font-family: "JetBrains Mono", "Fira Code", Menlo, monospace;
        margin: 0;
        background: #0d1117;
        color: #dce5ff;
      }
      header {
        padding: 16px 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      }
      main {
        display: flex;
        gap: 16px;
        padding: 16px 20px 40px;
      }
      section {
        flex: 1;
        min-width: 0;
      }
      h3 {
        margin-top: 0;
      }
      .card {
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 12px;
        background: rgba(255, 255, 255, 0.03);
      }
      .meta {
        font-size: 12px;
        opacity: 0.8;
      }
      button {
        background: transparent;
        color: inherit;
        border: 1px solid rgba(255, 255, 255, 0.2);
        padding: 6px 14px;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
      }
      button.approve {
        background: #2ea043;
        border-color: #2ea043;
        color: #03270f;
      }
      button.reject {
        border-color: #ff7b72;
        color: #ff7b72;
      }
      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .history-entry pre {
        margin: 6px 0 0;
        padding: 8px;
        background: rgba(0, 0, 0, 0.25);
        border-radius: 4px;
        overflow-x: auto;
      }
      .status.ok {
        color: #7ee787;
      }
      .status.fail {
        color: #ff7b72;
      }
      .error {
        color: #ff7b72;
        margin-top: 8px;
      }
      .result {
        margin-top: 8px;
        font-size: 13px;
        opacity: 0.85;
      }
      .pending-request {
        border: 2px solid #2ea043;
        background: rgba(46, 160, 67, 0.1);
      }
    </style>
  </head>
  <body>
    <header>
      <h2>Command Bridge Console</h2>
      <p class="meta">
        AI 提交命令后会自动排队，只有你同意才会真正执行。审批结果会同步发回
        AI，但不会在 UI 中显示。
      </p>
      <div id="error" class="error" hidden></div>
      <div id="result" class="result"></div>
    </header>
    <main>
      <section>
        <h3>待审批命令</h3>
        <div id="request-list"></div>
      </section>
      <section>
        <h3>最近执行</h3>
        <div id="history"></div>
      </section>
    </main>
    <script>
      const requestEl = document.getElementById("request-list");
      const historyEl = document.getElementById("history");
      const errorEl = document.getElementById("error");
      const resultEl = document.getElementById("result");

      // 从 URL 参数读取初始数据
      function readInitialState() {
        const params = new URLSearchParams(window.location.search);
        const stateParam = params.get("state");
        if (!stateParam) return null;
        try {
          let base = stateParam.replace(/-/g, "+").replace(/_/g, "/");
          while (base.length % 4 !== 0) {
            base += "=";
          }
          const json = atob(base);
          return JSON.parse(json);
        } catch (err) {
          console.warn("[Console] 解析初始状态失败", err);
          return null;
        }
      }

      // 初始化
      const initialState = readInitialState();
      let currentRequest = initialState?.request || null;
      let requestsList = initialState?.requests || [];
      let historyList = initialState?.history || [];

      // 如果没有单独的 request，从 requests 列表中找到第一个 Pending 的
      if (!currentRequest && requestsList.length > 0) {
        currentRequest =
          requestsList.find((r) => r.state === "Pending") || null;
      }

      // 立即渲染
      renderRequests(requestsList, currentRequest);
      renderHistory(historyList);

      // 点击事件处理
      requestEl.addEventListener("click", async (event) => {
        const target = event.target;
        if (!(target instanceof HTMLElement)) return;
        const id = target.dataset.id;
        if (!id) return;

        if (target.classList.contains("approve")) {
          await handleDecision(id, "approve");
        } else if (target.classList.contains("reject")) {
          await handleDecision(id, "reject");
        }
      });

      async function handleDecision(requestId, decision) {
        // 禁用所有按钮
        const buttons = requestEl.querySelectorAll("button");
        buttons.forEach((btn) => (btn.disabled = true));

        try {
          errorEl.hidden = true;
          resultEl.textContent = `正在处理...`;

          const response = await invokePluginTool("handle_request", {
            requestId,
            decision,
          });

          if (!response.success) {
            throw new Error(response.error || "审批失败");
          }

          const data = response.data || {};
          resultEl.textContent = `命令已${
            decision === "approve" ? "执行" : "拒绝"
          }`;

          // 如果有结果，更新显示
          if (data.status) {
            // 重新获取状态以更新列表
            await refreshStatus();
          }

          // 发送工具执行结果给 AI
          // 优先使用 toolResult（工具执行结果），如果没有则使用 llmMessage（系统消息）
          if (data.toolResult) {
            // toolResult 是工具执行的结果，会被作为工具调用的返回值返回给 AI
            // 这样 AI 就能看到工具执行的结果，并基于结果继续对话
            await sendToPet(data.toolResult);
          } else if (data.llmMessage) {
            // 如果没有 toolResult，使用 llmMessage 作为系统消息
            await sendToPet(data.llmMessage);
          }
        } catch (err) {
          console.error("[Console] 处理失败", err);
          errorEl.textContent = `操作失败: ${err.message}`;
          errorEl.hidden = false;
        } finally {
          // 重新启用按钮
          buttons.forEach((btn) => (btn.disabled = false));
        }
      }

      async function refreshStatus() {
        try {
          const response = await invokePluginTool("bridge_status", {});
          if (response?.success && response.data) {
            const data = response.data;
            if (Array.isArray(data.requests)) {
              requestsList = data.requests;
            }
            if (Array.isArray(data.history)) {
              historyList = data.history;
            }
            // 找到当前请求的最新状态
            if (currentRequest) {
              const updated = requestsList.find(
                (r) => r.id === currentRequest.id
              );
              if (updated) {
                currentRequest = updated;
              }
            }
            renderRequests(requestsList, currentRequest);
            renderHistory(historyList);
          }
        } catch (err) {
          console.warn("[Console] 刷新状态失败", err);
        }
      }

      async function invokePluginTool(tool, args) {
        try {
          const payload = encodeURIComponent(JSON.stringify(args || {}));
          const url = `pluginevent://localhost/plugin-tool?plugin=command-bridge&tool=${tool}&args=${payload}`;
          const response = await fetch(url);

          if (!response.ok) {
            const errorText = await response.text().catch(() => "未知错误");
            throw new Error(`HTTP ${response.status}: ${errorText}`);
          }

          const result = await response.json();
          return result;
        } catch (err) {
          console.error(`[Console] 调用工具失败: ${tool}`, err);
          throw err;
        }
      }

      async function sendToPet(message) {
        if (!message) return;
        try {
          const url = `pluginevent://localhost/send-to-pet?message=${encodeURIComponent(
            message
          )}&bubble=&source=command-bridge`;
          await fetch(url);
        } catch (err) {
          console.warn("[Console] 发送消息失败", err);
        }
      }

      function renderRequests(requests, current) {
        if (!requests.length) {
          requestEl.innerHTML = "<p>暂无排队命令。</p>";
          return;
        }

        requestEl.innerHTML = requests
          .slice()
          .reverse()
          .map((req) => {
            const actionable = req.state === "Pending";
            const isCurrent = current && req.id === current.id;
            const created = new Date(
              req.created_at || req.createdAt || Date.now()
            ).toLocaleString();

            return `
              <article class="card ${isCurrent ? "pending-request" : ""}">
                <div><strong>${req.command}</strong> · ${req.path}</div>
                <div class="meta">
                  ${created} · includeHidden=${
              req.include_hidden ?? req.includeHidden
            }
                  · 状态：${req.state}${req.message ? ` · ${req.message}` : ""}
                </div>
                ${
                  actionable
                    ? `<div style="display:flex;gap:8px;margin-top:8px;">
                        <button class="approve" data-id="${req.id}">允许执行</button>
                        <button class="reject" data-id="${req.id}">拒绝</button>
                      </div>`
                    : ""
                }
                ${
                  req.stdout
                    ? `<pre style="margin-top:8px;font-size:12px;">${escapeHtml(
                        req.stdout.split("\n").slice(0, 10).join("\n")
                      )}</pre>`
                    : ""
                }
              </article>
            `;
          })
          .join("");
      }

      function renderHistory(records) {
        if (!records.length) {
          historyEl.innerHTML = "<p>暂无执行记录。</p>";
          return;
        }

        historyEl.innerHTML = records
          .slice()
          .reverse()
          .slice(0, 10) // 只显示最近 10 条
          .map((record) => {
            const status = record.success ? "ok" : "fail";
            const timestamp = new Date(record.timestamp).toLocaleString();
            return `
              <article class="card history-entry">
                <div><strong>${
                  record.display_name || record.command
                }</strong></div>
                <div class="meta">
                  <span class="status ${status}">exit ${
              record.status_code
            }</span>
                  · ${timestamp}
                  ${record.working_dir ? `· ${record.working_dir}` : ""}
                </div>
                <pre>${escapeHtml(
                  (record.stdout || "").split("\n").slice(0, 20).join("\n") ||
                    "(no stdout)"
                )}</pre>
                ${
                  record.stderr
                    ? `<pre style="color:#ff7b72;">stderr:\n${escapeHtml(
                        record.stderr
                      )}</pre>`
                    : ""
                }
              </article>
            `;
          })
          .join("");
      }

      function escapeHtml(input) {
        return (input || "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");
      }
    </script>
  </body>
</html>
